<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CarCare AI ‚Äì √éntre»õinere Ma»ôinƒÉ</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:      #08090d;
  --bg2:     #0f1117;
  --bg3:     #161921;
  --bg4:     #1c2030;
  --border:  #222736;
  --border2: #2c3347;
  --accent:  #c8f135;
  --accent-dim: rgba(200,241,53,.12);
  --accent2: #3fffa8;
  --accent3: #ff5e3a;
  --accent4: #4f8fff;
  --text:    #dde1ed;
  --text2:   #7a849a;
  --text3:   #3d4556;
  --ok:      #3fffa8;
  --ok-dim:  rgba(63,255,168,.1);
  --warn:    #ffc947;
  --warn-dim:rgba(255,201,71,.1);
  --danger:  #ff5e3a;
  --danger-dim:rgba(255,94,58,.1);
  --radius:  10px;
  --radius-lg:16px;
  --shadow:  0 2px 12px rgba(0,0,0,.5);
  --shadow-lg:0 8px 40px rgba(0,0,0,.6);
  --t:0.18s cubic-bezier(.4,0,.2,1);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:15px;-webkit-font-smoothing:antialiased}
body{background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;min-height:100vh;overflow-x:hidden}
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:var(--bg2)}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:var(--text3)}
button,input,select,textarea{font-family:inherit}
.app-shell{display:flex;min-height:100vh}

/* SIDEBAR */
.sidebar{width:228px;min-width:228px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;position:sticky;top:0;height:100vh;overflow:hidden;z-index:50}
.sidebar-logo{padding:20px 18px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:11px}
.logo-icon{width:36px;height:36px;background:var(--accent);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.15rem;flex-shrink:0;box-shadow:0 0 0 3px var(--accent-dim)}
.logo-name{font-size:.92rem;font-weight:800;color:var(--accent);letter-spacing:-.02em;line-height:1.1}
.logo-sub{font-size:.58rem;color:var(--text3);letter-spacing:.14em;text-transform:uppercase;margin-top:1px}
.nav{flex:1;padding:12px 8px;display:flex;flex-direction:column;gap:3px;overflow-y:auto}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--radius);cursor:pointer;color:var(--text2);font-size:.8rem;font-weight:600;transition:all var(--t);border:1px solid transparent;user-select:none}
.nav-item:hover{background:var(--bg3);color:var(--text)}
.nav-item.active{background:var(--accent-dim);color:var(--accent);border-color:rgba(200,241,53,.2)}
.nav-icon{font-size:1rem;width:20px;text-align:center;flex-shrink:0}
.nav-label{flex:1}
.nav-badge{background:var(--danger);color:#fff;font-size:.58rem;font-weight:700;padding:2px 5px;border-radius:20px;font-family:'JetBrains Mono',monospace;animation:pulse-b 2s infinite}
@keyframes pulse-b{0%,100%{opacity:1}50%{opacity:.6}}
.sidebar-footer{padding:12px 16px;border-top:1px solid var(--border);font-size:.65rem;color:var(--text3);display:flex;align-items:center;justify-content:space-between;gap:6px}
.btn-reset{font-size:.62rem;color:var(--text3);background:none;border:1px solid var(--border);border-radius:6px;padding:3px 8px;cursor:pointer;transition:all var(--t);font-family:'Syne',sans-serif;font-weight:600}
.btn-reset:hover{color:var(--danger);border-color:var(--danger)}

/* TOPBAR + MAIN */
.main{flex:1;overflow-y:auto;display:flex;flex-direction:column}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:13px 26px;border-bottom:1px solid var(--border);background:rgba(8,9,13,.9);backdrop-filter:blur(12px);position:sticky;top:0;z-index:10;gap:10px;flex-wrap:wrap}
.topbar-title{font-size:.95rem;font-weight:800;letter-spacing:-.025em;display:flex;align-items:center;gap:7px}
.topbar-actions{display:flex;gap:5px;flex-wrap:wrap}
.content{padding:22px 26px;flex:1}

/* SECTIONS */
.section{display:none}
.section.active{display:block;animation:fadeUp .22s ease both}
@keyframes fadeUp{from{opacity:0;transform:translateY(7px)}to{opacity:1;transform:none}}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:5px;padding:8px 15px;border-radius:var(--radius);font-size:.77rem;font-weight:700;cursor:pointer;border:1px solid transparent;transition:all var(--t);letter-spacing:.02em;white-space:nowrap;outline:none}
.btn:active{transform:scale(.97)}
.btn-primary{background:var(--accent);color:#090c02;border-color:var(--accent)}
.btn-primary:hover{filter:brightness(1.08);box-shadow:0 0 0 3px var(--accent-dim)}
.btn-secondary{background:var(--bg3);color:var(--text);border-color:var(--border)}
.btn-secondary:hover{border-color:var(--border2);background:var(--bg4)}
.btn-danger{background:var(--danger-dim);color:var(--danger);border-color:rgba(255,94,58,.3)}
.btn-danger:hover{background:rgba(255,94,58,.2)}
.btn-ghost{background:transparent;color:var(--text2);border-color:var(--border)}
.btn-ghost:hover{color:var(--text);background:var(--bg3)}
.btn-sm{padding:5px 11px;font-size:.72rem;border-radius:8px}
.btn-xs{padding:3px 8px;font-size:.67rem;border-radius:6px}
.btn:disabled{opacity:.4;cursor:not-allowed;transform:none}

/* CARDS */
.card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-lg);padding:20px;box-shadow:var(--shadow)}
.card-title{font-size:.63rem;font-weight:700;letter-spacing:.14em;text-transform:uppercase;color:var(--text3);margin-bottom:14px}

/* GRID */
.grid{display:grid;gap:15px}
.g2{grid-template-columns:repeat(2,1fr)}
.g3{grid-template-columns:repeat(3,1fr)}
.g4{grid-template-columns:repeat(4,1fr)}

/* STAT CARD */
.stat-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-lg);padding:16px 18px;display:flex;flex-direction:column;gap:3px;transition:border-color var(--t),box-shadow var(--t)}
.stat-card:hover{border-color:var(--border2);box-shadow:var(--shadow)}
.stat-label{font-size:.6rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--text3)}
.stat-value{font-size:1.85rem;font-weight:800;letter-spacing:-.04em;font-family:'JetBrains Mono',monospace;line-height:1}
.stat-sub{font-size:.68rem;color:var(--text2);margin-top:2px}
.stat-icon{font-size:1.2rem;margin-bottom:3px}

/* BADGE */
.badge{display:inline-flex;align-items:center;gap:4px;font-size:.6rem;font-weight:700;padding:3px 8px;border-radius:100px;font-family:'JetBrains Mono',monospace;letter-spacing:.06em;text-transform:uppercase}
.badge-ok{background:var(--ok-dim);color:var(--ok);border:1px solid rgba(63,255,168,.2)}
.badge-soon{background:var(--warn-dim);color:var(--warn);border:1px solid rgba(255,201,71,.2)}
.badge-overdue{background:var(--danger-dim);color:var(--danger);border:1px solid rgba(255,94,58,.2)}
.bdot{width:5px;height:5px;border-radius:50%;background:currentColor}

/* HEALTH RING */
.health-wrap{display:flex;align-items:center;gap:18px;flex-wrap:wrap}
.ring-box{position:relative;width:116px;height:116px;flex-shrink:0}
.ring-box canvas{display:block}
.ring-center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none}
.ring-score{font-size:1.7rem;font-weight:800;font-family:'JetBrains Mono',monospace;line-height:1}
.ring-lbl{font-size:.57rem;text-transform:uppercase;letter-spacing:.1em;color:var(--text3);margin-top:2px}
.risks-col{flex:1;min-width:160px;display:flex;flex-direction:column;gap:6px}
.risk-row{display:flex;align-items:center;gap:8px;padding:8px 11px;background:var(--bg3);border-radius:var(--radius);border:1px solid var(--border);transition:border-color var(--t)}
.risk-row:hover{border-color:var(--border2)}
.sev-b{font-size:.58rem;font-weight:700;padding:2px 6px;border-radius:5px;font-family:'JetBrains Mono';flex-shrink:0}
.sev-3{background:var(--danger-dim);color:var(--danger)}
.sev-2{background:var(--warn-dim);color:var(--warn)}
.sev-1{background:var(--ok-dim);color:var(--ok)}
.risk-name{font-size:.76rem;font-weight:600;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.risk-pts{font-size:.68rem;font-family:'JetBrains Mono';color:var(--danger);flex-shrink:0}

/* NOTIF */
.notif-item{display:flex;align-items:flex-start;gap:10px;padding:10px 13px;border-radius:var(--radius);background:var(--bg3);border:1px solid var(--border);margin-bottom:6px;transition:border-color var(--t)}
.notif-item:hover{border-color:var(--border2)}
.notif-item.is-overdue{border-color:rgba(255,94,58,.2);background:rgba(255,94,58,.03)}
.notif-item.is-soon{border-color:rgba(255,201,71,.18);background:rgba(255,201,71,.03)}
.notif-icon{font-size:.95rem;line-height:1.5;flex-shrink:0}
.notif-body{flex:1;min-width:0}
.notif-title{font-size:.78rem;font-weight:700;line-height:1.3}
.notif-sub{font-size:.68rem;color:var(--text2);margin-top:2px;line-height:1.4}

/* TABLE */
.tbl-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:.79rem}
th{text-align:left;padding:8px 11px;font-size:.6rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text3);border-bottom:1px solid var(--border);white-space:nowrap}
td{padding:9px 11px;border-bottom:1px solid var(--border);vertical-align:middle;line-height:1.4}
tr:last-child td{border-bottom:none}
tbody tr{transition:background var(--t)}
tbody tr:hover td{background:var(--bg3)}
.mono{font-family:'JetBrains Mono',monospace;font-size:.76rem}
.tmuted{color:var(--text2)}
.fw7{font-weight:700}
.ellip{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* FILTER TABS */
.ftabs{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:15px}
.ftab{padding:5px 13px;border-radius:100px;font-size:.69rem;font-weight:700;cursor:pointer;border:1px solid var(--border);color:var(--text2);background:var(--bg2);transition:all var(--t);font-family:'Syne',sans-serif;user-select:none}
.ftab:hover{border-color:var(--border2);color:var(--text)}
.ftab.active{background:var(--accent);color:#090c02;border-color:var(--accent)}

/* FORM */
.fgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:13px}
.ffull{grid-column:1/-1}
.field{display:flex;flex-direction:column;gap:5px}
.field label{font-size:.6rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text2)}
.field input,.field select,.field textarea{background:var(--bg3);border:1.5px solid var(--border);border-radius:var(--radius);color:var(--text);padding:8px 11px;font-size:.84rem;transition:border-color var(--t),box-shadow var(--t);width:100%}
.field input:focus,.field select:focus,.field textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim)}
.field input.invalid,.field select.invalid,.field textarea.invalid{border-color:var(--danger)!important;box-shadow:0 0 0 3px var(--danger-dim)!important}
.field .ferr{font-size:.63rem;color:var(--danger);margin-top:1px;display:none}
.field.has-err .ferr{display:block}
.field textarea{resize:vertical;min-height:70px}
select option{background:#161921}

/* SECTION HEADER */
.sec-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;gap:9px}
.sec-title{font-size:1rem;font-weight:800;letter-spacing:-.025em}

/* PROGRESS */
.progress{height:5px;background:var(--bg3);border-radius:3px;overflow:hidden}
.pfill{height:100%;border-radius:3px;transition:width .6s ease,background .4s}

/* QUICK ACTIONS */
.qa-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:11px;margin-bottom:18px}
.qa{background:var(--bg3);border:1.5px solid var(--border);border-radius:var(--radius-lg);padding:15px;cursor:pointer;display:flex;flex-direction:column;align-items:flex-start;gap:7px;transition:all var(--t);user-select:none}
.qa:hover{border-color:var(--accent);background:var(--accent-dim);transform:translateY(-2px);box-shadow:var(--shadow)}
.qa:active{transform:scale(.98)}
.qa-icon{font-size:1.4rem;line-height:1}
.qa-lbl{font-size:.78rem;font-weight:700}
.qa-sub{font-size:.67rem;color:var(--text2);line-height:1.3}

/* VEHICLE HEADER */
.vh{background:linear-gradient(135deg,var(--bg2) 0%,var(--bg3) 100%);border:1px solid var(--border);border-radius:var(--radius-lg);padding:18px 22px;margin-bottom:18px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
.vh-name{font-size:1.25rem;font-weight:800;letter-spacing:-.03em;line-height:1.2}
.vh-meta{font-size:.72rem;color:var(--text2);margin-top:4px;display:flex;gap:10px;flex-wrap:wrap}
.vh-pill{display:inline-flex;align-items:center;gap:5px;padding:5px 12px;border-radius:8px;background:var(--bg4);border:1px solid var(--border2);font-size:.76rem;font-weight:600}
.vh-km{font-family:'JetBrains Mono';color:var(--accent);font-weight:700}
.vh-right{display:flex;align-items:center;gap:7px;flex-wrap:wrap}
.score-pill{display:inline-flex;align-items:center;gap:5px;padding:5px 13px;border-radius:100px;font-size:.75rem;font-weight:700;font-family:'JetBrains Mono',monospace;border:1px solid}

/* AI PROMPT */
.prompt-box{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);padding:14px;font-size:.73rem;font-family:'JetBrains Mono',monospace;line-height:1.75;white-space:pre-wrap;color:var(--text);max-height:420px;overflow-y:auto}

/* CHARTS */
.chart-wrap canvas{display:block;width:100%!important}
.chart-legend{display:flex;flex-wrap:wrap;gap:7px;margin-top:9px}
.leg-dot{width:8px;height:8px;border-radius:2px;flex-shrink:0}
.leg-item{display:flex;align-items:center;gap:4px;font-size:.68rem;color:var(--text2)}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.76);backdrop-filter:blur(4px);z-index:200;align-items:center;justify-content:center;padding:20px}
.modal-overlay.open{display:flex}
.modal{background:var(--bg2);border:1px solid var(--border2);border-radius:var(--radius-lg);padding:26px;width:100%;max-width:530px;max-height:92vh;overflow-y:auto;box-shadow:0 24px 80px rgba(0,0,0,.7);animation:modalIn .2s ease both}
@keyframes modalIn{from{opacity:0;transform:scale(.96) translateY(8px)}to{opacity:1;transform:none}}
.modal-title{font-size:.97rem;font-weight:800;letter-spacing:-.02em;margin-bottom:20px;display:flex;align-items:center;gap:8px}
.modal-footer{display:flex;gap:7px;margin-top:20px;justify-content:flex-end}

/* TOAST */
.toast-tray{position:fixed;bottom:20px;right:20px;z-index:999;display:flex;flex-direction:column;gap:6px;pointer-events:none}
.toast{display:flex;align-items:center;gap:8px;background:var(--bg2);border:1px solid var(--border2);border-radius:var(--radius);padding:10px 14px;font-size:.78rem;font-weight:600;box-shadow:0 8px 32px rgba(0,0,0,.5);animation:toastIn .24s ease both;pointer-events:all;max-width:310px;transition:opacity .28s,transform .28s}
@keyframes toastIn{from{opacity:0;transform:translateX(14px)}to{opacity:1;transform:none}}
.toast.out{opacity:0;transform:translateX(14px)}
.toast-ico{font-size:.9rem;flex-shrink:0}
.toast.t-ok{border-color:rgba(63,255,168,.35);color:var(--ok)}
.toast.t-err{border-color:rgba(255,94,58,.35);color:var(--danger)}
.toast.t-info{border-color:rgba(79,143,255,.35);color:var(--accent4)}
.toast-x{margin-left:auto;cursor:pointer;opacity:.45;font-size:.85rem;padding:0 2px;line-height:1}
.toast-x:hover{opacity:1}

/* EMPTY */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:36px 20px;gap:8px;color:var(--text3);font-size:.8rem;text-align:center}
.empty-ico{font-size:2rem;opacity:.35}

/* DIVIDER */
hr.dv{border:none;border-top:1px solid var(--border);margin:16px 0}

/* RESPONSIVE */
@media(max-width:900px){
  .sidebar{width:56px;min-width:56px}
  .sidebar-logo{padding:13px 10px}
  .logo-name,.logo-sub,.nav-label,.nav-badge,.sidebar-footer span:not(.btn-reset){display:none}
  .logo-icon{margin:0}
  .btn-reset{display:none}
  .nav-item{justify-content:center;padding:10px}
  .g4{grid-template-columns:repeat(2,1fr)}
  .g3{grid-template-columns:1fr 1fr}
  .g2{grid-template-columns:1fr}
  .qa-grid{grid-template-columns:1fr}
  .content{padding:14px}
  .topbar{padding:11px 15px}
}
@media(max-width:580px){
  .g3{grid-template-columns:1fr}
  .g4{grid-template-columns:1fr 1fr}
  .fgrid{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div class="app-shell">

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-icon">üöó</div>
    <div>
      <div class="logo-name">CarCare AI</div>
      <div class="logo-sub">Maintenance OS</div>
    </div>
  </div>
  <nav class="nav">
    <div class="nav-item active" data-tab="dashboard"><span class="nav-icon">‚ö°</span><span class="nav-label">Dashboard</span></div>
    <div class="nav-item" data-tab="planner"><span class="nav-icon">üìÖ</span><span class="nav-label">Planner</span><span class="nav-badge" id="plannerBadge" style="display:none">0</span></div>
    <div class="nav-item" data-tab="log"><span class="nav-icon">üîß</span><span class="nav-label">Service Log</span></div>
    <div class="nav-item" data-tab="reports"><span class="nav-icon">üìä</span><span class="nav-label">Reports</span></div>
    <div class="nav-item" data-tab="ai"><span class="nav-icon">ü§ñ</span><span class="nav-label">AI Assistant</span></div>
  </nav>
  <div class="sidebar-footer">
    <span>v2.0 ¬∑ Local</span>
    <button class="btn-reset" onclick="confirmReset()">‚Ü∫ Reset</button>
  </div>
</aside>

<!-- MAIN -->
<main class="main">
  <header class="topbar">
    <div class="topbar-title"><span id="tbarIcon">‚ö°</span><span id="tbarText">Dashboard</span></div>
    <div class="topbar-actions">
      <button class="btn btn-ghost btn-sm" onclick="exportJSON()">‚¨á Export JSON</button>
      <label class="btn btn-ghost btn-sm" style="cursor:pointer">‚¨Ü Import<input type="file" accept=".json" style="display:none" onchange="importJSON(this)"></label>
      <button class="btn btn-primary btn-sm" onclick="exportPDF()">üìÑ PDF</button>
    </div>
  </header>

  <div class="content" id="appContent">

    <!-- DASHBOARD -->
    <div class="section active" id="section-dashboard">
      <div class="vh" id="vhCard">
        <div>
          <div class="vh-name" id="vhName">‚Äì</div>
          <div class="vh-meta" id="vhMeta"></div>
        </div>
        <div class="vh-right">
          <div class="vh-pill"><span class="vh-km" id="vhKm">‚Äì</span></div>
          <div class="score-pill" id="scorePill">‚Äì</div>
          <button class="btn btn-secondary btn-sm" onclick="openVehicleModal()">‚úèÔ∏è Editare</button>
        </div>
      </div>

      <div class="qa-grid">
        <div class="qa" onclick="openKmModal()"><div class="qa-icon">üõû</div><div class="qa-lbl">Update kilometraj</div><div class="qa-sub">ActualizeazƒÉ km curent</div></div>
        <div class="qa" onclick="switchTab('log');setTimeout(openAddEvent,120)"><div class="qa-icon">üîß</div><div class="qa-lbl">AdaugƒÉ interven»õie</div><div class="qa-sub">√énregistreazƒÉ o revizie</div></div>
        <div class="qa" onclick="exportPDF()"><div class="qa-icon">üìÑ</div><div class="qa-lbl">Export PDF</div><div class="qa-sub">GenereazƒÉ raport complet</div></div>
      </div>

      <div class="grid g4" style="margin-bottom:16px" id="statsRow"></div>

      <div class="grid g2" style="margin-bottom:16px">
        <div class="card">
          <div class="card-title">Scor SƒÉnƒÉtate</div>
          <div class="health-wrap">
            <div class="ring-box"><canvas id="healthCanvas" width="116" height="116"></canvas>
              <div class="ring-center"><div class="ring-score" id="ringScore">‚Äì</div><div class="ring-lbl">scor</div></div>
            </div>
            <div class="risks-col" id="risksList"></div>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Alerte Active</div>
          <div id="dashAlerts" style="max-height:230px;overflow-y:auto"></div>
        </div>
      </div>

      <div class="card">
        <div class="sec-hdr">
          <div class="sec-title">Ultimele interven»õii</div>
          <button class="btn btn-primary btn-sm" onclick="switchTab('log');setTimeout(openAddEvent,120)">+ AdaugƒÉ</button>
        </div>
        <div class="tbl-wrap">
          <table id="recentTable">
            <thead><tr><th>Data</th><th>Titlu</th><th>Categorie</th><th>Km</th><th>Cost</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- PLANNER -->
    <div class="section" id="section-planner">
      <div class="sec-hdr">
        <div class="sec-title">Planificator Revizii</div>
        <button class="btn btn-ghost btn-sm" onclick="simulateNotif()">üîî SimuleazƒÉ notificare</button>
      </div>
      <div class="ftabs" id="plannerFilters">
        <div class="ftab active" data-f="all">Toate</div>
        <div class="ftab" data-f="OVERDUE">üî¥ DepƒÉ»ôite</div>
        <div class="ftab" data-f="DUE_SOON">üü° Curand</div>
        <div class="ftab" data-f="OK">üü¢ OK</div>
      </div>
      <div class="card" style="margin-bottom:16px">
        <div class="tbl-wrap">
          <table id="plannerTable">
            <thead><tr><th>Opera»õiune</th><th>Ultima datƒÉ</th><th>Ultim km</th><th>Due km</th><th>Due date</th><th>Status</th><th>Sev.</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="sec-hdr"><div class="sec-title">NotificƒÉri</div></div>
      <div id="plannerNotifs"></div>
    </div>

    <!-- SERVICE LOG -->
    <div class="section" id="section-log">
      <div class="sec-hdr">
        <div class="sec-title">Istoric Service</div>
        <button class="btn btn-primary" onclick="openAddEvent()">+ AdaugƒÉ interven»õie</button>
      </div>
      <div class="card">
        <div class="tbl-wrap">
          <table id="logTable">
            <thead><tr><th>Data</th><th>Titlu</th><th>Categorie</th><th>Km</th><th>Cost (RON)</th><th>Note</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- REPORTS -->
    <div class="section" id="section-reports">
      <div class="sec-hdr">
        <div class="sec-title">Rapoarte Costuri</div>
        <div style="display:flex;align-items:center;gap:7px;flex-wrap:wrap">
          <span style="font-size:.68rem;color:var(--text2);font-weight:700">De la</span>
          <input type="date" id="rFrom" style="padding:5px 9px;background:var(--bg3);border:1.5px solid var(--border);border-radius:8px;color:var(--text);font-family:'Syne',sans-serif;font-size:.76rem">
          <span style="font-size:.68rem;color:var(--text2);font-weight:700">P√¢nƒÉ la</span>
          <input type="date" id="rTo" style="padding:5px 9px;background:var(--bg3);border:1.5px solid var(--border);border-radius:8px;color:var(--text);font-family:'Syne',sans-serif;font-size:.76rem">
          <button class="btn btn-primary btn-sm" onclick="renderReports()">AplicƒÉ</button>
        </div>
      </div>
      <div class="grid g3" style="margin-bottom:16px" id="reportStats"></div>
      <div class="grid g2" style="margin-bottom:16px">
        <div class="card"><div class="card-title">Cost pe lunƒÉ (RON)</div><div class="chart-wrap"><canvas id="chartMonthly" height="180"></canvas></div></div>
        <div class="card"><div class="card-title">Cost pe categorie (RON)</div><div class="chart-wrap"><canvas id="chartCategory" height="180"></canvas></div><div class="chart-legend" id="catLegend"></div></div>
      </div>
      <div class="card">
        <div class="card-title">Detalii interven»õii filtrate</div>
        <div class="tbl-wrap">
          <table id="reportTable">
            <thead><tr><th>Data</th><th>Titlu</th><th>Categorie</th><th>Cost (RON)</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- AI ASSISTANT -->
    <div class="section" id="section-ai">
      <div class="sec-hdr"><div class="sec-title">AI Assistant</div></div>
      <div class="grid g2" style="margin-bottom:18px">
        <div class="card">
          <div class="card-title">Parametri generare</div>
          <div class="fgrid" style="margin-bottom:14px">
            <div class="field"><label>Utilizare zilnicƒÉ</label>
              <select id="aiUsage"><option value="urban">Urban (ora»ô)</option><option value="highway">AutostradƒÉ</option><option value="mixed" selected>Mixt</option><option value="offroad">Off-road</option></select>
            </div>
            <div class="field"><label>Km/lunƒÉ estima»õi</label><input type="number" id="aiMonthlyKm" value="1500" min="100"></div>
            <div class="field ffull"><label>Observa»õii suplimentare</label><textarea id="aiNotes" placeholder="Sunete neobi»ônuite, vibra»õii, probleme cunoscute..."></textarea></div>
          </div>
          <button class="btn btn-primary" style="width:100%" onclick="generatePrompt()">ü§ñ GenereazƒÉ prompt pentru Claude</button>
        </div>
        <div class="card">
          <div class="card-title">Cum func»õioneazƒÉ</div>
          <div style="font-size:.79rem;color:var(--text2);line-height:1.85;display:flex;flex-direction:column;gap:9px">
            <div><span style="color:var(--accent);font-weight:700">1.</span> CompleteazƒÉ parametrii »ôi apasƒÉ GenereazƒÉ</div>
            <div><span style="color:var(--accent);font-weight:700">2.</span> Se creeazƒÉ un prompt complet cu toate datele ma»ôinii</div>
            <div><span style="color:var(--accent);font-weight:700">3.</span> CopiazƒÉ cu butonul <strong style="color:var(--accent)">Copy</strong></div>
            <div><span style="color:var(--accent);font-weight:700">4.</span> Deschide <strong style="color:var(--accent4)">claude.ai</strong> »ôi lipe»ôte</div>
            <div><span style="color:var(--accent);font-weight:700">5.</span> Prime»ôti plan: urgent ¬∑ preventiv ¬∑ buget ¬∑ 3 luni</div>
          </div>
        </div>
      </div>
      <div class="card" id="aiCard" style="display:none">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:13px;flex-wrap:wrap;gap:7px">
          <div class="card-title" style="margin-bottom:0">Prompt generat</div>
          <div style="display:flex;gap:6px">
            <button class="btn btn-primary btn-sm" onclick="copyPrompt()">üìã Copy</button>
            <button class="btn btn-ghost btn-sm" onclick="document.getElementById('aiCard').style.display='none'">‚úï</button>
          </div>
        </div>
        <div class="prompt-box" id="aiPromptText"></div>
      </div>
    </div>

  </div>
</main>
</div>

<!-- VEHICLE MODAL -->
<div class="modal-overlay" id="vehicleModal">
  <div class="modal">
    <div class="modal-title">üöó Editare vehicul</div>
    <div class="fgrid">
      <div class="field" id="f-vMake"><label>MarcƒÉ *</label><input id="vMake" placeholder="Dacia"><div class="ferr">C√¢mp obligatoriu</div></div>
      <div class="field" id="f-vModel"><label>Model *</label><input id="vModel" placeholder="Logan"><div class="ferr">C√¢mp obligatoriu</div></div>
      <div class="field" id="f-vYear"><label>An fabrica»õie *</label><input id="vYear" type="number" placeholder="2019" min="1900"><div class="ferr">An invalid (1900‚Äì2030)</div></div>
      <div class="field"><label>Combustibil</label>
        <select id="vFuel"><option value="benzina">Benzina</option><option value="diesel">Diesel</option><option value="hybrid">Hybrid</option><option value="electric">Electric</option><option value="GPL">GPL</option></select>
      </div>
      <div class="field"><label>Nr. √Ænmatriculare</label><input id="vPlate" placeholder="AG-01-XYZ"></div>
      <div class="field" id="f-vKm"><label>Kilometraj curent *</label><input id="vKm" type="number" placeholder="87500" min="0"><div class="ferr">Km trebuie sƒÉ fie ‚â• 0</div></div>
      <div class="field"><label>Utilizare</label>
        <select id="vUsage"><option value="urban">Urban</option><option value="highway">AutostradƒÉ</option><option value="mixed">Mixt</option><option value="offroad">Off-road</option></select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('vehicleModal')">AnuleazƒÉ</button>
      <button class="btn btn-primary" onclick="saveVehicle()">‚úì SalveazƒÉ</button>
    </div>
  </div>
</div>

<!-- KM MODAL -->
<div class="modal-overlay" id="kmModal">
  <div class="modal" style="max-width:370px">
    <div class="modal-title">üõû ActualizeazƒÉ kilometraj</div>
    <div class="field" id="f-newKm">
      <label>Kilometraj nou *</label>
      <input id="newKmVal" type="number" placeholder="ex: 90000" min="0">
      <div class="ferr">Trebuie sƒÉ fie mai mare dec√¢t km curent</div>
    </div>
    <div style="font-size:.7rem;color:var(--text2);margin-top:8px">Km curent: <span class="mono" id="kmCurrentLbl"></span></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('kmModal')">AnuleazƒÉ</button>
      <button class="btn btn-primary" onclick="saveKm()">‚úì ActualizeazƒÉ</button>
    </div>
  </div>
</div>

<!-- EVENT MODAL -->
<div class="modal-overlay" id="eventModal">
  <div class="modal">
    <div class="modal-title" id="eventModalTitle">‚ûï AdaugƒÉ interven»õie</div>
    <div class="fgrid">
      <div class="field" id="f-evDate"><label>Data *</label><input id="evDate" type="date"><div class="ferr">Data este obligatorie</div></div>
      <div class="field" id="f-evKm"><label>Km la interven»õie *</label><input id="evKm" type="number" min="0" placeholder="87500"><div class="ferr">Km invalid (‚â• 0)</div></div>
      <div class="field"><label>Categorie</label>
        <select id="evCategory">
          <option value="oil_change">Schimb ulei</option><option value="air_filter">Filtru aer</option>
          <option value="cabin_filter">Filtru habitaclu</option><option value="brake_fluid">Lichid fr√¢ne</option>
          <option value="timing_belt">Curea distribu»õie</option><option value="tires">Anvelope</option>
          <option value="itp">ITP</option><option value="brakes">Fr√¢ne</option>
          <option value="battery">Baterie</option><option value="other">Altele</option>
        </select>
      </div>
      <div class="field" id="f-evTitle"><label>Titlu / Descriere *</label><input id="evTitle" placeholder="ex: Schimb ulei Castrol 5W40"><div class="ferr">C√¢mp obligatoriu</div></div>
      <div class="field"><label>Cost (RON)</label><input id="evCost" type="number" step="0.01" min="0" placeholder="250"></div>
      <div class="field ffull"><label>Note</label><textarea id="evNotes" placeholder="Detalii, piese, service..."></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('eventModal')">AnuleazƒÉ</button>
      <button class="btn btn-primary" onclick="saveEvent()">‚úì SalveazƒÉ</button>
    </div>
  </div>
</div>

<!-- CONFIRM MODAL -->
<div class="modal-overlay" id="confirmModal">
  <div class="modal" style="max-width:370px">
    <div class="modal-title">‚ö†Ô∏è Confirmare</div>
    <div id="confirmMsg" style="font-size:.83rem;color:var(--text2);line-height:1.65;margin-bottom:2px"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('confirmModal')">AnuleazƒÉ</button>
      <button class="btn btn-danger" id="confirmOkBtn">Confirmare</button>
    </div>
  </div>
</div>

<div class="toast-tray" id="toastTray"></div>

<script>
// =============================================
// DATA
// =============================================
const LS = 'carcare_v2';
const SEED = {
  vehicle:{ make:'Dacia', model:'Logan', year:2019, fuel:'diesel', plate:'AG-01-XYZ', currentKm:87500, usage:'mixed' },
  serviceRules:[
    {id:'oil_change',  name:'Schimb ulei',       intervalKm:10000,intervalMonths:12,severity:2,category:'oil_change'},
    {id:'air_filter',  name:'Filtru aer',         intervalKm:15000,intervalMonths:12,severity:1,category:'air_filter'},
    {id:'cabin_filter',name:'Filtru habitaclu',   intervalKm:15000,intervalMonths:12,severity:1,category:'cabin_filter'},
    {id:'brake_fluid', name:'Lichid fr√¢ne',       intervalKm:0,    intervalMonths:24,severity:2,category:'brake_fluid'},
    {id:'timing_belt', name:'Curea distribu»õie',  intervalKm:60000,intervalMonths:48,severity:3,category:'timing_belt'},
    {id:'tires',       name:'Anvelope',           intervalKm:40000,intervalMonths:36,severity:2,category:'tires'},
    {id:'itp',         name:'ITP',                intervalKm:0,    intervalMonths:24,severity:3,category:'itp'},
  ],
  serviceEvents:[
    {id:'ev1',date:'2023-11-10',km:80000,category:'oil_change',  title:'Schimb ulei Castrol 5W40',     cost:250, notes:'Ulei + filtru Mann'},
    {id:'ev2',date:'2023-11-10',km:80000,category:'air_filter',  title:'Filtru aer Mann',              cost:80,  notes:''},
    {id:'ev3',date:'2023-03-15',km:75000,category:'cabin_filter',title:'Filtru habitaclu carbon activ',cost:60,  notes:''},
    {id:'ev4',date:'2022-06-20',km:62000,category:'brake_fluid', title:'Lichid fr√¢ne DOT 4',           cost:120, notes:'Schimb complet'},
    {id:'ev5',date:'2021-09-05',km:40000,category:'tires',       title:'Michelin Primacy 4 205/55R16', cost:1800,notes:'4 anvelope noi'},
    {id:'ev6',date:'2024-01-18',km:83000,category:'itp',         title:'ITP valabil 01.2026',          cost:90,  notes:'Statie autorizata'},
  ],
  settings:{dueSoonKm:500,dueSoonDays:14}
};

function loadApp(){try{const r=localStorage.getItem(LS);if(r)return JSON.parse(r);}catch(e){}return null;}
function persist(){localStorage.setItem(LS,JSON.stringify(APP));}
let APP = loadApp() || JSON.parse(JSON.stringify(SEED));
if(!APP.settings) APP.settings={dueSoonKm:500,dueSoonDays:14};

// =============================================
// UTILS
// =============================================
const uid=()=>'ev'+Date.now()+Math.random().toString(36).slice(2,5);
const todayStr=()=>new Date().toISOString().slice(0,10);
const fmtDate=d=>{if(!d)return'‚Äì';const[y,m,dd]=d.split('-');return`${dd}.${m}.${y}`;};
const fmtKm=n=>(n===undefined||n===null||n==='')? '‚Äì': Number(n).toLocaleString('ro-RO')+' km';
const fmtCost=n=>Number(n||0).toFixed(2)+' RON';
const CATS={oil_change:'Schimb ulei',air_filter:'Filtru aer',cabin_filter:'Filtru habitaclu',brake_fluid:'Lichid fr√¢ne',timing_belt:'Curea distrib.',tires:'Anvelope',itp:'ITP',brakes:'Fr√¢ne',battery:'Baterie',other:'Altele'};
const catLbl=c=>CATS[c]||c;

function addMonths(dateStr,months){
  if(!dateStr)return null;
  const d=new Date(dateStr);d.setMonth(d.getMonth()+months);
  return d.toISOString().slice(0,10);
}
function daysDiff(dateStr){
  const d=new Date(dateStr),t=new Date();
  t.setHours(0,0,0,0);d.setHours(0,0,0,0);
  return Math.round((d-t)/86400000);
}

// =============================================
// TOAST
// =============================================
function toast(msg,type='ok',dur=3100){
  const icons={ok:'‚úì',err:'‚úï',info:'‚Ñπ'};
  const tray=document.getElementById('toastTray');
  const el=document.createElement('div');
  el.className=`toast t-${type}`;
  el.innerHTML=`<span class="toast-ico">${icons[type]||'‚Ä¢'}</span><span style="flex:1">${msg}</span><span class="toast-x" onclick="this.parentNode.remove()">‚úï</span>`;
  tray.appendChild(el);
  setTimeout(()=>{el.classList.add('out');setTimeout(()=>el.remove(),300);},dur);
}

// =============================================
// VALIDATION
// =============================================
function clearErr(fid){const f=document.getElementById('f-'+fid);if(!f)return;f.classList.remove('has-err');const i=f.querySelector('input,select,textarea');if(i)i.classList.remove('invalid');}
function setErr(fid){const f=document.getElementById('f-'+fid);if(!f)return;f.classList.add('has-err');const i=f.querySelector('input,select,textarea');if(i)i.classList.add('invalid');}
function clearErrs(ids){ids.forEach(clearErr);}

// =============================================
// NAV
// =============================================
const TAB_META={dashboard:{icon:'‚ö°',label:'Dashboard'},planner:{icon:'üìÖ',label:'Planner'},log:{icon:'üîß',label:'Service Log'},reports:{icon:'üìä',label:'Reports'},ai:{icon:'ü§ñ',label:'AI Assistant'}};
let curTab='dashboard';
function switchTab(tab){
  if(curTab===tab)return;
  curTab=tab;
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.toggle('active',n.dataset.tab===tab));
  document.querySelectorAll('.section').forEach(s=>s.classList.toggle('active',s.id==='section-'+tab));
  const m=TAB_META[tab];
  document.getElementById('tbarIcon').textContent=m.icon;
  document.getElementById('tbarText').textContent=m.label;
  if(tab==='dashboard')renderDashboard();
  else if(tab==='planner')renderPlanner();
  else if(tab==='log')renderLog();
  else if(tab==='reports')renderReports();
}
document.querySelectorAll('.nav-item').forEach(n=>n.addEventListener('click',()=>switchTab(n.dataset.tab)));

// =============================================
// PLANNER ENGINE
// =============================================
function computePlanner(){
  const{vehicle,serviceRules,serviceEvents,settings}=APP;
  const km=vehicle.currentKm,now=todayStr();
  return serviceRules.map(rule=>{
    const evs=serviceEvents.filter(e=>e.category===rule.category||e.category===rule.id).sort((a,b)=>new Date(b.date)-new Date(a.date));
    const last=evs[0]||null;
    const dueKm=(rule.intervalKm>0&&last)?last.km+rule.intervalKm:null;
    const dueDate=(rule.intervalMonths>0&&last)?addMonths(last.date,rule.intervalMonths):null;
    let status='OK';
    if(!last){status='OVERDUE';}
    else{
      const ko=dueKm!==null&&km>dueKm,dto=dueDate!==null&&now>dueDate;
      if(ko||dto){status='OVERDUE';}
      else{
        const ks=dueKm!==null&&(dueKm-km)<=settings.dueSoonKm;
        const ds=dueDate!==null&&daysDiff(dueDate)>=0&&daysDiff(dueDate)<=settings.dueSoonDays;
        if(ks||ds)status='DUE_SOON';
      }
    }
    let extraKm=false,extraDays=false;
    if(status==='OVERDUE'){
      if(dueKm!==null&&km>dueKm+2000)extraKm=true;
      if(dueDate!==null&&daysDiff(dueDate)<-30)extraDays=true;
    }
    return{rule,last,lastKm:last?.km??null,lastDate:last?.date??null,dueKm,dueDate,status,extraKm,extraDays};
  });
}
function computeHealth(items){
  let score=100;const risks=[];
  for(const item of items){
    const s=item.rule.severity;let p=0;
    if(item.status==='DUE_SOON'){p=s===1?5:s===2?10:15;}
    if(item.status==='OVERDUE'){p=s===1?10:s===2?20:30;if(item.extraKm||item.extraDays)p+=10;}
    if(p>0){score-=p;risks.push({...item,penalty:p});}
  }
  score=Math.max(0,score);
  risks.sort((a,b)=>b.penalty-a.penalty);
  return{score,top3:risks.slice(0,3),all:risks};
}

// =============================================
// DASHBOARD
// =============================================
function renderDashboard(){
  const{vehicle,serviceEvents}=APP;
  const planner=computePlanner();
  const{score,top3,all}=computeHealth(planner);
  const sc=score;
  const col=sc>=75?'var(--ok)':sc>=50?'var(--warn)':'var(--danger)';
  const bg=sc>=75?'var(--ok-dim)':sc>=50?'var(--warn-dim)':'var(--danger-dim)';
  const bc=sc>=75?'rgba(63,255,168,.3)':sc>=50?'rgba(255,201,71,.3)':'rgba(255,94,58,.3)';

  document.getElementById('vhName').textContent=`${vehicle.make} ${vehicle.model} ${vehicle.year}`;
  document.getElementById('vhMeta').innerHTML=`<span>${vehicle.plate||'FƒÉrƒÉ placƒÉ'}</span><span>${vehicle.fuel||''}</span><span>${vehicle.year}</span>`;
  document.getElementById('vhKm').textContent=fmtKm(vehicle.currentKm);
  const sp=document.getElementById('scorePill');
  sp.textContent=`‚ù§ ${sc}/100`;
  sp.style.cssText=`color:${col};background:${bg};border-color:${bc};display:inline-flex;align-items:center;gap:5px;padding:5px 13px;border-radius:100px;font-size:.74rem;font-weight:700;font-family:'JetBrains Mono',monospace;border:1px solid`;

  const od=planner.filter(p=>p.status==='OVERDUE').length;
  const sn=planner.filter(p=>p.status==='DUE_SOON').length;
  const tot=serviceEvents.reduce((s,e)=>s+e.cost,0);
  document.getElementById('statsRow').innerHTML=`
    <div class="stat-card"><div class="stat-icon">‚ù§Ô∏è</div><div class="stat-label">Scor sƒÉnƒÉtate</div><div class="stat-value" style="color:${col}">${sc}</div><div class="stat-sub">din 100</div></div>
    <div class="stat-card"><div class="stat-icon">üî¥</div><div class="stat-label">DepƒÉ»ôite</div><div class="stat-value" style="color:var(--danger)">${od}</div><div class="stat-sub">revizii restante</div></div>
    <div class="stat-card"><div class="stat-icon">üü°</div><div class="stat-label">Curand</div><div class="stat-value" style="color:var(--warn)">${sn}</div><div class="stat-sub">scadente</div></div>
    <div class="stat-card"><div class="stat-icon">üí∂</div><div class="stat-label">Cheltuieli totale</div><div class="stat-value" style="font-size:1.4rem">${tot.toFixed(0)}</div><div class="stat-sub">RON</div></div>
  `;

  drawRing(sc);
  document.getElementById('ringScore').textContent=sc;
  document.getElementById('ringScore').style.color=col;

  const rl=document.getElementById('risksList');
  rl.innerHTML=top3.length===0?`<div style="color:var(--ok);font-size:.79rem;font-weight:700">‚úì Toate reviziile la zi!</div>`:
    top3.map(r=>`<div class="risk-row"><span class="sev-b sev-${r.rule.severity}">S${r.rule.severity}</span><span class="risk-name">${r.rule.name}</span><span class="badge badge-${r.status==='OVERDUE'?'overdue':'soon'}" style="flex-shrink:0">${r.status==='OVERDUE'?'OVER':'SOON'}</span><span class="risk-pts">-${r.penalty}</span></div>`).join('');

  const da=document.getElementById('dashAlerts');
  da.innerHTML=all.length===0?`<div class="empty"><div class="empty-ico">üéâ</div>Nicio alertƒÉ activƒÉ!</div>`:
    all.slice(0,5).map(p=>`<div class="notif-item ${p.status==='OVERDUE'?'is-overdue':'is-soon'}"><div class="notif-icon">${p.status==='OVERDUE'?'üö®':'‚ö†Ô∏è'}</div><div class="notif-body"><div class="notif-title">${p.rule.name}</div><div class="notif-sub">${plannerNote(p)}</div></div></div>`).join('');

  const sorted=[...serviceEvents].sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,6);
  document.querySelector('#recentTable tbody').innerHTML=sorted.length===0?`<tr><td colspan="5" style="text-align:center;color:var(--text3);padding:22px">Nicio interven»õie √ÆnregistratƒÉ</td></tr>`:
    sorted.map(e=>`<tr><td class="mono">${fmtDate(e.date)}</td><td class="fw7">${e.title}</td><td class="tmuted">${catLbl(e.category)}</td><td class="mono">${fmtKm(e.km)}</td><td class="mono">${fmtCost(e.cost)}</td></tr>`).join('');

  const bn=od+sn;
  const badge=document.getElementById('plannerBadge');
  badge.style.display=bn>0?'':'none';badge.textContent=bn;
}

function drawRing(score){
  const c=document.getElementById('healthCanvas');
  const ctx=c.getContext('2d'),cx=58,cy=58,r=46,lw=9;
  ctx.clearRect(0,0,116,116);
  ctx.beginPath();ctx.arc(cx,cy,r,0,2*Math.PI);ctx.strokeStyle='rgba(255,255,255,.05)';ctx.lineWidth=lw;ctx.stroke();
  const col=score>=75?'#3fffa8':score>=50?'#ffc947':'#ff5e3a';
  const end=-Math.PI/2+(score/100)*2*Math.PI;
  ctx.beginPath();ctx.arc(cx,cy,r,-Math.PI/2,end);ctx.strokeStyle=col;ctx.lineWidth=lw;ctx.lineCap='round';ctx.stroke();
}

// =============================================
// PLANNER
// =============================================
let planFilter='all';
function renderPlanner(){
  const planner=computePlanner();
  document.querySelectorAll('#plannerFilters .ftab').forEach(t=>{
    t.classList.toggle('active',t.dataset.f===planFilter);
    t.onclick=()=>{planFilter=t.dataset.f;renderPlanner();};
  });
  const filtered=planFilter==='all'?planner:planner.filter(p=>p.status===planFilter);
  const tb=document.querySelector('#plannerTable tbody');
  tb.innerHTML=filtered.length===0?`<tr><td colspan="7" style="text-align:center;color:var(--text3);padding:22px">Nicio regulƒÉ</td></tr>`:
    filtered.map(p=>`<tr><td class="fw7">${p.rule.name}</td><td class="mono tmuted">${fmtDate(p.lastDate)}</td><td class="mono tmuted">${p.lastKm!==null?fmtKm(p.lastKm):'‚Äì'}</td><td class="mono">${p.dueKm!==null?fmtKm(p.dueKm):'‚Äì'}</td><td class="mono">${p.dueDate?fmtDate(p.dueDate):'‚Äì'}</td><td>${sBadge(p.status)}</td><td><span class="sev-b sev-${p.rule.severity}">S${p.rule.severity}</span></td></tr>`).join('');

  const alerts=planner.filter(p=>p.status!=='OK');
  const ne=document.getElementById('plannerNotifs');
  ne.innerHTML=alerts.length===0?`<div class="card" style="text-align:center;color:var(--ok);font-weight:700;font-size:.84rem;padding:18px">‚úì Totul este la zi!</div>`:
    alerts.map(p=>`<div class="notif-item ${p.status==='OVERDUE'?'is-overdue':'is-soon'}"><div class="notif-icon">${p.status==='OVERDUE'?'üö®':'‚ö†Ô∏è'}</div><div class="notif-body"><div class="notif-title">${p.rule.name} ‚Äì ${p.status==='OVERDUE'?'DEPƒÇ»òIT':'SCADENT √éN CUR√ÇND'}</div><div class="notif-sub">${plannerNote(p)}</div></div><button class="btn btn-primary btn-sm" style="flex-shrink:0" onclick="switchTab('log');setTimeout(()=>{openAddEvent();document.getElementById('evCategory').value='${p.rule.category}'},140)">AdaugƒÉ</button></div>`).join('');
}
function plannerNote(p){
  const parts=[];
  if(p.dueKm!==null){const d=p.dueKm-APP.vehicle.currentKm;parts.push(d<0?`DepƒÉ»ôit cu ${Math.abs(d).toLocaleString('ro-RO')} km`:`Mai sunt ${d.toLocaleString('ro-RO')} km (due: ${fmtKm(p.dueKm)})`);}
  if(p.dueDate){const d=daysDiff(p.dueDate);parts.push(d<0?`DatƒÉ depƒÉ»ôitƒÉ cu ${Math.abs(d)} zile (${fmtDate(p.dueDate)})`:`Scadent √Æn ${d} zile (${fmtDate(p.dueDate)})`);}
  return parts.join(' ¬∑ ')||'Nicio interven»õie √ÆnregistratƒÉ';
}
function sBadge(s){
  if(s==='OK')return'<span class="badge badge-ok"><span class="bdot"></span>OK</span>';
  if(s==='DUE_SOON')return'<span class="badge badge-soon"><span class="bdot"></span>DUE SOON</span>';
  return'<span class="badge badge-overdue"><span class="bdot"></span>OVERDUE</span>';
}
function simulateNotif(){
  const alerts=computePlanner().filter(p=>p.status!=='OK');
  if(alerts.length===0){toast('Nicio alertƒÉ activƒÉ! üéâ');return;}
  const a=alerts[0];
  alert(`üîî CarCare AI ‚Äì Notificare\n\n${a.rule.name}\nStatus: ${a.status}\n${plannerNote(a)}`);
}

// =============================================
// SERVICE LOG
// =============================================
let editEvId=null;
function renderLog(){
  const sorted=[...APP.serviceEvents].sort((a,b)=>new Date(b.date)-new Date(a.date));
  const tb=document.querySelector('#logTable tbody');
  tb.innerHTML=sorted.length===0?`<tr><td colspan="7" style="text-align:center;color:var(--text3);padding:28px">Nicio interven»õie. ApasƒÉ "+ AdaugƒÉ"</td></tr>`:
    sorted.map(e=>`<tr><td class="mono">${fmtDate(e.date)}</td><td class="fw7">${e.title}</td><td class="tmuted">${catLbl(e.category)}</td><td class="mono">${fmtKm(e.km)}</td><td class="mono">${fmtCost(e.cost)}</td><td class="tmuted ellip" style="max-width:130px" title="${e.notes||''}">${e.notes||'‚Äì'}</td><td><div style="display:flex;gap:3px"><button class="btn btn-secondary btn-xs" onclick="editEvent('${e.id}')">‚úèÔ∏è</button><button class="btn btn-danger btn-xs" onclick="deleteEvent('${e.id}')">üóë</button></div></td></tr>`).join('');
}
function openAddEvent(){
  editEvId=null;
  document.getElementById('eventModalTitle').textContent='‚ûï AdaugƒÉ interven»õie';
  document.getElementById('evDate').value=todayStr();
  document.getElementById('evKm').value=APP.vehicle.currentKm;
  document.getElementById('evCategory').value='oil_change';
  document.getElementById('evTitle').value='';
  document.getElementById('evCost').value='';
  document.getElementById('evNotes').value='';
  clearErrs(['evDate','evKm','evTitle']);
  openModal('eventModal');
}
function editEvent(id){
  const ev=APP.serviceEvents.find(e=>e.id===id);if(!ev)return;
  editEvId=id;
  document.getElementById('eventModalTitle').textContent='‚úèÔ∏è Editare interven»õie';
  document.getElementById('evDate').value=ev.date;
  document.getElementById('evKm').value=ev.km;
  document.getElementById('evCategory').value=ev.category;
  document.getElementById('evTitle').value=ev.title;
  document.getElementById('evCost').value=ev.cost;
  document.getElementById('evNotes').value=ev.notes||'';
  clearErrs(['evDate','evKm','evTitle']);
  openModal('eventModal');
}
function saveEvent(){
  const date=document.getElementById('evDate').value;
  const km=Number(document.getElementById('evKm').value);
  const cat=document.getElementById('evCategory').value;
  const title=document.getElementById('evTitle').value.trim();
  const cost=Number(document.getElementById('evCost').value)||0;
  const notes=document.getElementById('evNotes').value.trim();
  let ok=true;clearErrs(['evDate','evKm','evTitle']);
  if(!date){setErr('evDate');ok=false;}
  if(isNaN(km)||km<0){setErr('evKm');ok=false;}
  if(!title){setErr('evTitle');ok=false;}
  if(!ok){toast('CorecteazƒÉ c√¢mpurile eviden»õiate','err');return;}
  if(editEvId){
    const i=APP.serviceEvents.findIndex(e=>e.id===editEvId);
    if(i>=0)APP.serviceEvents[i]={...APP.serviceEvents[i],date,km,category:cat,title,cost,notes};
    toast('Interven»õie actualizatƒÉ ‚úì');
  }else{
    APP.serviceEvents.push({id:uid(),date,km,category:cat,title,cost,notes});
    toast('Interven»õie adƒÉugatƒÉ ‚úì');
  }
  persist();closeModal('eventModal');renderLog();
}
function deleteEvent(id){
  confirm2('E»ôti sigur cƒÉ vrei sƒÉ »ôtergi aceastƒÉ interven»õie?',()=>{
    APP.serviceEvents=APP.serviceEvents.filter(e=>e.id!==id);
    persist();renderLog();toast('Interven»õie »ôtearsƒÉ');
  });
}

// =============================================
// VEHICLE MODAL
// =============================================
function openVehicleModal(){
  const v=APP.vehicle;
  document.getElementById('vMake').value=v.make;document.getElementById('vModel').value=v.model;
  document.getElementById('vYear').value=v.year;document.getElementById('vFuel').value=v.fuel;
  document.getElementById('vPlate').value=v.plate||'';document.getElementById('vKm').value=v.currentKm;
  document.getElementById('vUsage').value=v.usage;
  clearErrs(['vMake','vModel','vYear','vKm']);
  openModal('vehicleModal');
}
function saveVehicle(){
  const make=document.getElementById('vMake').value.trim();
  const model=document.getElementById('vModel').value.trim();
  const year=Number(document.getElementById('vYear').value);
  const fuel=document.getElementById('vFuel').value;
  const plate=document.getElementById('vPlate').value.trim();
  const km=Number(document.getElementById('vKm').value);
  const usage=document.getElementById('vUsage').value;
  let ok=true;clearErrs(['vMake','vModel','vYear','vKm']);
  if(!make){setErr('vMake');ok=false;}
  if(!model){setErr('vModel');ok=false;}
  if(!year||year<1900||year>2030){setErr('vYear');ok=false;}
  if(isNaN(km)||km<0){setErr('vKm');ok=false;}
  if(!ok){toast('CorecteazƒÉ c√¢mpurile eviden»õiate','err');return;}
  APP.vehicle={make,model,year,fuel,plate,currentKm:km,usage};
  persist();closeModal('vehicleModal');renderDashboard();toast('Vehicul actualizat ‚úì');
}

// =============================================
// KM MODAL
// =============================================
function openKmModal(){
  document.getElementById('kmCurrentLbl').textContent=fmtKm(APP.vehicle.currentKm);
  document.getElementById('newKmVal').value='';
  clearErrs(['newKm']);openModal('kmModal');
}
function saveKm(){
  const val=Number(document.getElementById('newKmVal').value);
  clearErrs(['newKm']);
  if(!val||val<APP.vehicle.currentKm){setErr('newKm');toast('Km nou trebuie sƒÉ fie mai mare dec√¢t cel curent','err');return;}
  APP.vehicle.currentKm=val;persist();closeModal('kmModal');renderDashboard();toast(`Km actualizat la ${fmtKm(val)} ‚úì`);
}

// =============================================
// REPORTS
// =============================================
const PAL=['#c8f135','#3fffa8','#ff5e3a','#4f8fff','#b47fff','#ff47b4','#47fff0','#ffa347'];
function renderReports(){
  const{serviceEvents}=APP;
  const from=document.getElementById('rFrom').value,to=document.getElementById('rTo').value;
  let evs=[...serviceEvents];
  if(from)evs=evs.filter(e=>e.date>=from);
  if(to)evs=evs.filter(e=>e.date<=to);
  const total=evs.reduce((s,e)=>s+e.cost,0);
  const byC={},byM={};
  for(const e of evs){
    byC[e.category]=(byC[e.category]||0)+e.cost;
    const mo=e.date.slice(0,7);byM[mo]=(byM[mo]||0)+e.cost;
  }
  document.getElementById('reportStats').innerHTML=`
    <div class="stat-card"><div class="stat-label">Total costuri</div><div class="stat-value" style="font-size:1.45rem">${total.toFixed(0)}</div><div class="stat-sub">RON filtrat</div></div>
    <div class="stat-card"><div class="stat-label">Nr. interven»õii</div><div class="stat-value">${evs.length}</div><div class="stat-sub">opera»õiuni</div></div>
    <div class="stat-card"><div class="stat-label">Cost mediu</div><div class="stat-value" style="font-size:1.45rem">${evs.length?Math.round(total/evs.length):0}</div><div class="stat-sub">RON/interven»õie</div></div>
  `;
  const months=Object.keys(byM).sort();
  drawBar('chartMonthly',months.map(m=>m.slice(5)+'/'+m.slice(2,4)),months.map(m=>byM[m]));
  const cats=Object.keys(byC);
  drawPie('chartCategory',cats.map(catLbl),cats.map(c=>byC[c]),PAL);
  document.getElementById('catLegend').innerHTML=cats.map((c,i)=>`<div class="leg-item"><div class="leg-dot" style="background:${PAL[i%PAL.length]}"></div><span>${catLbl(c)}: ${byC[c].toFixed(0)}</span></div>`).join('');
  const se=[...evs].sort((a,b)=>new Date(b.date)-new Date(a.date));
  document.querySelector('#reportTable tbody').innerHTML=se.length===0?`<tr><td colspan="4" style="text-align:center;color:var(--text3);padding:22px">Nicio interven»õie</td></tr>`:
    se.map(e=>`<tr><td class="mono">${fmtDate(e.date)}</td><td class="fw7">${e.title}</td><td class="tmuted">${catLbl(e.category)}</td><td class="mono">${fmtCost(e.cost)}</td></tr>`).join('');
}
function drawBar(id,labels,values){
  const canvas=document.getElementById(id);if(!canvas)return;
  const W=canvas.parentElement.offsetWidth||400;canvas.width=W;canvas.height=180;
  const ctx=canvas.getContext('2d');ctx.clearRect(0,0,W,180);
  if(!values.length||values.every(v=>v===0)){ctx.fillStyle='rgba(255,255,255,.2)';ctx.font='12px Syne';ctx.textAlign='center';ctx.fillText('FƒÉrƒÉ date',W/2,90);return;}
  const max=Math.max(...values,1);
  const pad={l:42,r:8,t:14,b:26};
  const cW=W-pad.l-pad.r,cH=180-pad.t-pad.b;
  const gap=cW/labels.length,bw=Math.max(6,gap*.55);
  ctx.strokeStyle='rgba(255,255,255,.04)';ctx.lineWidth=1;
  for(let i=0;i<=4;i++){const y=pad.t+cH*(1-i/4);ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(W-pad.r,y);ctx.stroke();ctx.fillStyle='rgba(255,255,255,.2)';ctx.font='9px JetBrains Mono';ctx.textAlign='right';ctx.fillText(Math.round(max*i/4),pad.l-4,y+3);}
  labels.forEach((lbl,i)=>{
    const x=pad.l+i*gap+gap/2,bh=(values[i]/max)*cH,y=pad.t+cH-bh,bx=x-bw/2;
    const grad=ctx.createLinearGradient(bx,y,bx,y+bh);grad.addColorStop(0,'#c8f135');grad.addColorStop(1,'rgba(200,241,53,.25)');
    ctx.fillStyle=grad;
    if(ctx.roundRect)ctx.roundRect(bx,y,bw,bh,[3,3,0,0]);else ctx.rect(bx,y,bw,bh);ctx.fill();
    ctx.fillStyle='rgba(255,255,255,.3)';ctx.font='9px Syne';ctx.textAlign='center';ctx.fillText(lbl,x,178);
    if(values[i]>0){ctx.fillStyle='rgba(255,255,255,.6)';ctx.font='9px JetBrains Mono';ctx.fillText(Math.round(values[i]),x,y-3);}
  });
}
function drawPie(id,labels,values,colors){
  const canvas=document.getElementById(id);if(!canvas)return;
  const W=canvas.parentElement.offsetWidth||300;canvas.width=W;canvas.height=180;
  const ctx=canvas.getContext('2d');ctx.clearRect(0,0,W,180);
  const total=values.reduce((s,v)=>s+v,0);
  if(!total){ctx.fillStyle='rgba(255,255,255,.2)';ctx.font='12px Syne';ctx.textAlign='center';ctx.fillText('FƒÉrƒÉ date',W/2,90);return;}
  const cx=W/2,cy=90,r=70,ir=38;let angle=-Math.PI/2;
  values.forEach((v,i)=>{const sl=(v/total)*2*Math.PI;ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,r,angle,angle+sl);ctx.closePath();ctx.fillStyle=colors[i%colors.length];ctx.fill();angle+=sl;});
  ctx.beginPath();ctx.arc(cx,cy,ir,0,2*Math.PI);ctx.fillStyle='var(--bg2)';ctx.fill();
  ctx.fillStyle='rgba(255,255,255,.55)';ctx.font='bold 10px JetBrains Mono';ctx.textAlign='center';ctx.fillText(Math.round(total)+' RON',cx,cy+4);
}

// =============================================
// AI PROMPT
// =============================================
function generatePrompt(){
  const{vehicle,serviceEvents}=APP;
  const usage=document.getElementById('aiUsage').value;
  const monthKm=document.getElementById('aiMonthlyKm').value;
  const notes=document.getElementById('aiNotes').value.trim();
  const planner=computePlanner();
  const{score}=computeHealth(planner);
  const lastEvs=[...serviceEvents].sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,8);
  const evsTxt=lastEvs.length?lastEvs.map(e=>`  - ${fmtDate(e.date)} | ${e.km} km | ${catLbl(e.category)} | ${e.title} | ${e.cost} RON${e.notes?' ('+e.notes+')':''}`).join('\n'):'  (nicio interven»õie)';
  const planTxt=planner.map(p=>`  - ${p.rule.name}: ${p.status}, ultima_data=${p.lastDate||'?'}, ultima_km=${p.lastKm||'?'}, due_km=${p.dueKm||'‚Äì'}, due_date=${p.dueDate||'‚Äì'}, sev=${p.rule.severity}`).join('\n');
  const prompt=`E»ôti un mecanic auto expert. AnalizeazƒÉ ma»ôina mea.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
DATE VEHICUL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚Ä¢ ${vehicle.make} ${vehicle.model} (${vehicle.year}) ¬∑ ${vehicle.fuel}
‚Ä¢ Km actual: ${vehicle.currentKm.toLocaleString('ro-RO')} km
‚Ä¢ PlacƒÉ: ${vehicle.plate} ¬∑ Utilizare: ${usage}
‚Ä¢ Km/lunƒÉ: ~${monthKm} km
‚Ä¢ Scor sƒÉnƒÉtate: ${score}/100
${notes?'‚Ä¢ Observa»õii: '+notes:''}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ULTIMELE 8 INTERVEN»öII
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
${evsTxt}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
STATUS PLANIFICATOR
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
${planTxt}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ANALIZƒÇ CERUTƒÇ
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

1. üö® URGENT (max 2 sƒÉptƒÉm√¢ni)
   - Ce trebuie rezolvat urgent + motive + consecin»õe

2. üîß RECOMANDAT (1-3 luni)
   - Interven»õii preventive

3. üí∞ BUGET ESTIMAT
   - Minim / Recomandat / Complet (RON)

4. üìÖ PLAN 3 LUNI
   - Luna 1 | 2 | 3 (km estima»õi la ${monthKm} km/lunƒÉ)

5. ‚ö° SFATURI pentru ${vehicle.make} ${vehicle.model} ${vehicle.year}
   - Probleme cunoscute, uzuri accelerate

RƒÉspunde √Æn rom√¢nƒÉ, cu cifre concrete.`;
  document.getElementById('aiPromptText').textContent=prompt;
  document.getElementById('aiCard').style.display='block';
  document.getElementById('aiCard').scrollIntoView({behavior:'smooth',block:'start'});
  toast('Prompt generat! ApasƒÉ Copy üìã','info');
}
function copyPrompt(){
  const text=document.getElementById('aiPromptText').textContent;
  const fb=()=>{const ta=document.createElement('textarea');ta.value=text;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);toast('Copiat! üìã');};
  navigator.clipboard?navigator.clipboard.writeText(text).then(()=>toast('Copiat √Æn clipboard! üìã')).catch(fb):fb();
}

// =============================================
// EXPORT / IMPORT / PDF
// =============================================
function exportJSON(){
  const blob=new Blob([JSON.stringify(APP,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`carcare_${todayStr()}.json`;a.click();
  toast('Date exportate ‚úì');
}
function importJSON(input){
  const file=input.files[0];if(!file)return;
  const r=new FileReader();
  r.onload=e=>{
    try{
      const data=JSON.parse(e.target.result);
      if(!data.vehicle||!data.serviceEvents)throw new Error('Format invalid');
      APP=data;if(!APP.settings)APP.settings={dueSoonKm:500,dueSoonDays:14};
      persist();renderDashboard();toast('Date importate ‚úì');
    }catch(err){toast('Eroare import: '+err.message,'err');}
  };
  r.readAsText(file);input.value='';
}
function exportPDF(){
  const planner=computePlanner();
  const{score,all}=computeHealth(planner);
  const v=APP.vehicle,evs=APP.serviceEvents,total=evs.reduce((s,e)=>s+e.cost,0);
  const sc=score>=75?'#2e7d32':score>=50?'#e65100':'#b71c1c';
  const el=document.createElement('div');
  el.style.cssText='font-family:Arial,sans-serif;padding:28px;max-width:800px;background:white;color:#111;line-height:1.5;font-size:13px';
  el.innerHTML=`
    <div style="display:flex;justify-content:space-between;border-bottom:3px solid #111;padding-bottom:12px;margin-bottom:18px">
      <div><h1 style="margin:0;font-size:20px">üöó CarCare AI ‚Äì Raport Mentenan»õƒÉ</h1><p style="margin:3px 0 0;color:#666;font-size:11px">Generat: ${fmtDate(todayStr())}</p></div>
      <div style="text-align:right"><div style="font-size:30px;font-weight:900;color:${sc}">${score}</div><div style="font-size:10px;color:#888;text-transform:uppercase">Scor /100</div></div>
    </div>
    <h2 style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#555;border-bottom:1px solid #eee;padding-bottom:5px;margin-bottom:9px">Date Vehicul</h2>
    <table style="width:100%;margin-bottom:16px;font-size:12px">
      <tr><td style="padding:3px 0;color:#666;width:130px">MarcƒÉ/Model</td><td style="font-weight:700">${v.make} ${v.model} ${v.year}</td><td style="padding:3px 0;color:#666;width:130px">√énmatriculare</td><td style="font-weight:700">${v.plate||'N/A'}</td></tr>
      <tr><td style="padding:3px 0;color:#666">Combustibil</td><td>${v.fuel}</td><td style="padding:3px 0;color:#666">Kilometraj</td><td style="font-weight:700">${v.currentKm.toLocaleString('ro-RO')} km</td></tr>
    </table>
    <h2 style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#555;border-bottom:1px solid #eee;padding-bottom:5px;margin-bottom:9px">Riscuri</h2>
    <div style="margin-bottom:16px">${all.length===0?'<p style="color:green;font-size:12px">‚úì Toate la zi!</p>':all.map(r=>`<div style="padding:6px 10px;margin-bottom:4px;border-radius:3px;background:${r.status==='OVERDUE'?'#fff0ee':'#fffde7'};border-left:3px solid ${r.status==='OVERDUE'?'#b71c1c':'#f57c00'};font-size:12px"><strong>${r.rule.name}</strong> <span style="color:${r.status==='OVERDUE'?'#b71c1c':'#e65100'}">${r.status}</span> ¬∑ -${r.penalty} pct ¬∑ Sev ${r.rule.severity}</div>`).join('')}</div>
    <h2 style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#555;border-bottom:1px solid #eee;padding-bottom:5px;margin-bottom:9px">Planificator</h2>
    <table style="width:100%;border-collapse:collapse;font-size:11px;margin-bottom:16px">
      <thead><tr style="background:#f5f5f5">${['Opera»õiune','Ultima datƒÉ','Due km','Due date','Status'].map(h=>`<th style="padding:5px 7px;text-align:left;border:1px solid #ddd">${h}</th>`).join('')}</tr></thead>
      <tbody>${planner.map(p=>`<tr style="background:${p.status==='OVERDUE'?'#fff0ee':p.status==='DUE_SOON'?'#fffde7':'white'}"><td style="padding:4px 7px;border:1px solid #ddd;font-weight:700">${p.rule.name}</td><td style="padding:4px 7px;border:1px solid #ddd">${fmtDate(p.lastDate)}</td><td style="padding:4px 7px;border:1px solid #ddd">${p.dueKm?fmtKm(p.dueKm):'‚Äì'}</td><td style="padding:4px 7px;border:1px solid #ddd">${p.dueDate?fmtDate(p.dueDate):'‚Äì'}</td><td style="padding:4px 7px;border:1px solid #ddd;font-weight:700;color:${p.status==='OVERDUE'?'#b71c1c':p.status==='DUE_SOON'?'#e65100':'#2e7d32'}">${p.status}</td></tr>`).join('')}</tbody>
    </table>
    <h2 style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#555;border-bottom:1px solid #eee;padding-bottom:5px;margin-bottom:9px">Costuri</h2>
    <p style="font-size:20px;font-weight:900;margin-bottom:3px">${total.toFixed(2)} RON</p><p style="font-size:11px;color:#666">${evs.length} interven»õii</p>
    <div style="margin-top:24px;padding-top:10px;border-top:1px solid #eee;font-size:9px;color:#aaa;text-align:center">CarCare AI ¬∑ ${fmtDate(todayStr())}</div>
  `;
  document.body.appendChild(el);
  html2pdf().set({margin:10,filename:`CarCare_${todayStr()}.pdf`,image:{type:'jpeg',quality:.95},html2canvas:{scale:2,useCORS:true},jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}}).from(el).save().then(()=>{document.body.removeChild(el);toast('PDF exportat ‚úì');});
}

// =============================================
// CONFIRM / RESET
// =============================================
function confirm2(msg,onOk){
  document.getElementById('confirmMsg').textContent=msg;
  document.getElementById('confirmOkBtn').onclick=()=>{closeModal('confirmModal');onOk();};
  openModal('confirmModal');
}
function confirmReset(){
  confirm2('Toate datele vor fi √Ænlocuite cu datele demo. AceastƒÉ ac»õiune nu poate fi anulatƒÉ.',()=>{
    APP=JSON.parse(JSON.stringify(SEED));persist();renderDashboard();toast('Date demo restaurate ‚úì','info');
  });
}

// =============================================
// MODAL
// =============================================
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.modal-overlay').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('open');}));
document.addEventListener('keydown',e=>{if(e.key==='Escape')document.querySelectorAll('.modal-overlay.open').forEach(m=>m.classList.remove('open'));});

// =============================================
// INIT
// =============================================
window.addEventListener('DOMContentLoaded',()=>{
  renderDashboard();
  const yr1=new Date();yr1.setFullYear(yr1.getFullYear()-1);
  document.getElementById('rFrom').value=yr1.toISOString().slice(0,10);
  document.getElementById('rTo').value=todayStr();
  let rt;window.addEventListener('resize',()=>{clearTimeout(rt);rt=setTimeout(()=>{if(curTab==='reports')renderReports();},180);});
});
</script>
</body>
</html>
